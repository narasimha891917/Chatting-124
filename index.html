<!DOCTYPE html>
<html>
<head>
  <title>Advanced Call System</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    video {
      width: 300px;
      height: auto;
      border-radius: 10px;
      margin: 10px;
      background: black;
    }
    .controls, .call-options {
      margin: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .start {
      background: #28a745;
      color: white;
    }
    .end {
      background: #dc3545;
      color: white;
    }
    .mute {
      background: #ffc107;
      color: black;
    }
    .ringing-ui {
      position: absolute;
      top: 20%;
      background: #222;
      padding: 30px;
      border-radius: 15px;
      display: none;
      text-align: center;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }
    .ringing-ui h3 {
      margin-bottom: 20px;
    }
    .ringing-ui button {
      margin: 10px;
    }
    #timer {
      margin-top: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Call System</h1>
  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div class="controls">
    <button class="start" onclick="startAudioCall()">Start Audio Call</button>
    <button class="start" onclick="startVideoCall()">Start Video Call</button>
  </div>

  <div class="call-options">
    <button class="mute" onclick="toggleMute()">Toggle Mute</button>
    <button class="end" onclick="endCall()">End Call</button>
  </div>

  <div id="timer"></div>

  <div class="ringing-ui" id="ringingUI">
    <h3>Incoming Call...</h3>
    <button class="start" onclick="acceptCall()">Accept</button>
    <button class="end" onclick="rejectCall()">Reject</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_5OXqGIcR2yH_nGC8GVgmLwJfJaQnmuw",
      authDomain: "student-dashboard-821ae.firebaseapp.com",
      projectId: "student-dashboard-821ae",
      storageBucket: "student-dashboard-821ae.appspot.com",
      messagingSenderId: "785480958148",
      appId: "1:785480958148:web:bb187cfe8d969aafca0991",
      measurementId: "G-01QDZ9VRJ4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let localStream, remoteStream, peerConnection;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const ringingUI = document.getElementById('ringingUI');
    let callDoc, offerCandidates, answerCandidates;
    let callTimer;
    let seconds = 0;

    async function startCall(video) {
      localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
      remoteStream = new MediaStream();
      localVideo.srcObject = localStream;
      remoteVideo.srcObject = remoteStream;

      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
      peerConnection.onicecandidate = e => e.candidate && offerCandidates.add(e.candidate.toJSON());

      callDoc = db.collection('calls').doc('callRoom');
      offerCandidates = callDoc.collection('offerCandidates');
      answerCandidates = callDoc.collection('answerCandidates');

      const offerDescription = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offerDescription);
      const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
      await callDoc.set({ offer, video });

      callDoc.onSnapshot(snapshot => {
        const data = snapshot.data();
        if (!peerConnection.currentRemoteDescription && data?.answer) {
          const answerDesc = new RTCSessionDescription(data.answer);
          peerConnection.setRemoteDescription(answerDesc);
          startTimer();
        }
      });

      answerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });
    }

    async function answerCall() {
      ringingUI.style.display = 'none';
      const callData = (await db.collection('calls').doc('callRoom').get()).data();
      localStream = await navigator.mediaDevices.getUserMedia({ video: callData.video, audio: true });
      remoteStream = new MediaStream();
      localVideo.srcObject = localStream;
      remoteVideo.srcObject = remoteStream;

      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
      peerConnection.onicecandidate = e => e.candidate && answerCandidates.add(e.candidate.toJSON());

      await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
      const answerDescription = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answerDescription);
      const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
      await callDoc.update({ answer });
      startTimer();
    }

    function startAudioCall() {
      callDoc = db.collection('calls').doc('callRoom');
      callDoc.set({ ringing: true });
      startCall(false);
    }

    function startVideoCall() {
      callDoc = db.collection('calls').doc('callRoom');
      callDoc.set({ ringing: true });
      startCall(true);
    }

    function toggleMute() {
      localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
    }

    function endCall() {
      stopTimer();
      if (peerConnection) peerConnection.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      db.collection('calls').doc('callRoom').delete();
      window.location.reload();
    }

    function rejectCall() {
      db.collection('calls').doc('callRoom').delete();
      ringingUI.style.display = 'none';
    }

    function acceptCall() {
      answerCall();
    }

    function startTimer() {
      callTimer = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('timer').innerText = `Call Duration: ${mins}:${secs < 10 ? '0' + secs : secs}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(callTimer);
      document.getElementById('timer').innerText = '';
    }

    // Check for incoming calls
    db.collection('calls').doc('callRoom').onSnapshot(doc => {
      if (doc.exists && doc.data().ringing) {
        ringingUI.style.display = 'block';
      }
    });
  </script>
</body>
</html>
